<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UOL Televisão - Display de Notícias</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Preact CDN -->
    <script src="https://unpkg.com/preact@10/dist/preact.umd.js"></script>
    <script src="https://unpkg.com/preact@10/hooks/dist/hooks.umd.js"></script>
    
    <!-- Babel Standalone para transformar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        // Configura Babel para transformar JSX para Preact
        window.Babel = window.Babel || {};
        window.Babel.availablePlugins = window.Babel.availablePlugins || {};
        window.Babel.availablePlugins['transform-react-jsx'] = function() {
            return {
                visitor: {}
            };
        };
    </script>
    
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script>
        // Configuração customizada do Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        'cpf-red': {
                            500: '#7F0D14',
                            700: 'rgba(127, 13, 20, 0.7)',
                            900: 'rgba(127, 13, 20, 0.9)',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full m-0 p-0 overflow-hidden bg-gray-800 font-poppins">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-plugins="transform-react-jsx" data-presets="react">
        /** @jsx h */
        const { h, render } = preact;
        const { useState, useEffect, useCallback } = preactHooks;

        // Configurações
        const CONFIG = {
            API_URL: "https://rss.suatv.com.br/BBC/Convert/Brasil.php",
            ROTATION_INTERVAL: 5 * 1000, // 5 segundos
            FETCH_INTERVAL: 5 * 60 * 1000 // 5 minutos
        };

        // Hook customizado para gerenciar RSS
        const useNewsData = () => {
            const [newsItems, setNewsItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const fetchNews = useCallback(async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    const response = await fetch(CONFIG.API_URL);
                    if (!response.ok) {
                        throw new Error(`Erro de rede (${response.status} ${response.statusText})`);
                    }

                    const arrayBuffer = await response.arrayBuffer();
                    const decoder = new TextDecoder('utf-8');
                    const text = decoder.decode(arrayBuffer);
                    
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(text, 'application/xml');
                    const items = xml.querySelectorAll('item');

                    if (items.length > 0) {
                        const newsData = Array.from(items).map(item => {
                            const titleElement = item.querySelector('title');
                            const descriptionElement = item.querySelector('description');
                            const imgSrcElement = item.querySelector('linkfoto');
                            const dateElement = item.querySelector('date');
                            
                            return {
                                title: titleElement?.textContent?.trim() || '',
                                description: descriptionElement?.textContent?.trim() || '',
                                image: imgSrcElement?.textContent?.trim() || '',
                                date: dateElement?.textContent?.trim() || ''
                            };
                        });
                        
                        setNewsItems(newsData);
                        console.log(`${newsData.length} notícias carregadas do RSS`);
                    } else {
                        throw new Error('Nenhuma notícia encontrada no feed');
                    }
                } catch (err) {
                    console.error('Erro ao buscar notícias:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                fetchNews();
                const interval = setInterval(fetchNews, CONFIG.FETCH_INTERVAL);
                return () => clearInterval(interval);
            }, [fetchNews]);

            return { newsItems, loading, error, refetch: fetchNews };
        };

        // Hook para rotação automática
        const useAutoRotation = (items) => {
            const [currentIndex, setCurrentIndex] = useState(0);

            useEffect(() => {
                if (items.length === 0) return;

                const interval = setInterval(() => {
                    setCurrentIndex(prevIndex => (prevIndex + 1) % items.length);
                }, CONFIG.ROTATION_INTERVAL);

                return () => clearInterval(interval);
            }, [items.length]);

            return { currentIndex, currentItem: items[currentIndex] };
        };

        // Componente Header
        const Header = () => (
            <div className="absolute top-5 right-5 bg-cpf-red-700 px-4 py-2 rounded z-30">
                <div className="text-white text-2xl font-black font-poppins">CPF TV</div>
            </div>
        );

        // Componente Background
        const BackgroundImage = ({ imageUrl }) => {
            const bgStyle = {
                backgroundImage: imageUrl ? `url('${imageUrl}')` : 'none',
                backgroundSize: 'cover',
                backgroundPosition: 'center',
                transition: 'background-image 0.5s ease-in-out'
            };
            
            return (
                <div 
                    className="flex-1 relative  bg-gray-800" 
                    style={bgStyle}
                />
            );
        };

        // Componente Source Bar
        const SourceBar = () => (
            <div className="w-full bg-black bg-opacity-60 px-8 py-3 flex justify-end items-center z-10">
                <div className="flex items-center gap-3">
                    <span className="text-white text-base font-bold font-poppins">
                        Fonte: UOL Televisão
                    </span>
                    <img 
                        src="https://rss.kxmidia.com.br/news/imgs/uollogo.png" 
                        alt="Logo UOL" 
                        className="max-h-9"
                        onError={(e) => e.target.style.display = 'none'}
                    />
                </div>
            </div>
        );

        // Componente Footer
        const NewsFooter = ({ title, isLoading, error }) => {
            let content = title;
            
            if (isLoading) {
                content = "Carregando notícias...";
            } else if (error) {
                content = `Erro: ${error}`;
            } else if (!title) {
                content = "Título indisponível";
            }

            return (
                <div className="bg-cpf-red-900 text-white text-left px-8 py-5 text-2xl font-bold font-poppins leading-tight z-20">
                    {error && <span className="text-red-400">⚠️ </span>}
                    {content}
                </div>
            );
        };

        // Loading Spinner Component
        const LoadingSpinner = () => (
            <div className="h-screen w-full flex justify-center items-center bg-gray-800">
                <div className="text-white text-xl font-poppins animate-pulse">
                    Carregando notícias...
                </div>
            </div>
        );

        // Componente principal
        const NewsDisplay = () => {
            const { newsItems, loading, error } = useNewsData();
            const { currentIndex, currentItem } = useAutoRotation(newsItems);

            useEffect(() => {
                if (currentItem) {
                    const title = currentItem.description || currentItem.title || 'Título indisponível';
                    console.log(`Exibindo notícia ${currentIndex + 1}/${newsItems.length}: ${title}`);
                }
            }, [currentIndex, currentItem, newsItems.length]);

            if (loading && newsItems.length === 0) {
                return <LoadingSpinner />;
            }

            return (
                <div className="h-full w-full flex flex-col justify-between overflow-hidden">
                    <Header />
                    <BackgroundImage imageUrl={currentItem?.image} />
                    <SourceBar />
                    <NewsFooter 
                        title={currentItem?.description || currentItem?.title}
                        isLoading={loading}
                        error={error}
                    />
                </div>
            );
        };

        // Renderiza a aplicação com Preact
        render(<NewsDisplay />, document.getElementById('root'));
    </script>
</body>
</html>
